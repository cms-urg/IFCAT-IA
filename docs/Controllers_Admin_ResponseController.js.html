<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controllers/Admin/ResponseController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Controller.AdminController.AdminController.html">AdminController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.AdminController.html#getCourses">getCourses</a></li></ul></li><li><a href="Controller.AdminController.AdminSocketController.html">AdminSocketController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.AdminSocketController.html#getJoinedStudents">getJoinedStudents</a></li><li data-type='method'><a href="Controller.AdminController.AdminSocketController.html#requestJoinTutorialQuiz">requestJoinTutorialQuiz</a></li></ul></li><li><a href="Controller.AdminController.FileController.html">FileController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.FileController.html#addFiles">addFiles</a></li><li data-type='method'><a href="Controller.AdminController.FileController.html#deleteFiles">deleteFiles</a></li><li data-type='method'><a href="Controller.AdminController.FileController.html#getFiles">getFiles</a></li></ul></li><li><a href="Controller.AdminController.GroupController.html">GroupController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.GroupController.html#generateGroups">generateGroups</a></li><li data-type='method'><a href="Controller.AdminController.GroupController.html#saveGroups">saveGroups</a></li></ul></li><li><a href="Controller.AdminController.QuestionController.html">QuestionController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.QuestionController.html#addQuestion">addQuestion</a></li><li data-type='method'><a href="Controller.AdminController.QuestionController.html#deleteQuestion">deleteQuestion</a></li><li data-type='method'><a href="Controller.AdminController.QuestionController.html#editQuestion">editQuestion</a></li><li data-type='method'><a href="Controller.AdminController.QuestionController.html#getQuestion">getQuestion</a></li><li data-type='method'><a href="Controller.AdminController.QuestionController.html#getQuestions">getQuestions</a></li><li data-type='method'><a href="Controller.AdminController.QuestionController.html#previewQuestion">previewQuestion</a></li><li data-type='method'><a href="Controller.AdminController.QuestionController.html#sortQuestions">sortQuestions</a></li></ul></li><li><a href="Controller.AdminController.QuizController.html">QuizController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.QuizController.html#addQuiz">addQuiz</a></li><li data-type='method'><a href="Controller.AdminController.QuizController.html#copyQuiz">copyQuiz</a></li><li data-type='method'><a href="Controller.AdminController.QuizController.html#deleteQuiz">deleteQuiz</a></li><li data-type='method'><a href="Controller.AdminController.QuizController.html#editQuiz">editQuiz</a></li><li data-type='method'><a href="Controller.AdminController.QuizController.html#getQuiz">getQuiz</a></li><li data-type='method'><a href="Controller.AdminController.QuizController.html#getQuizzes">getQuizzes</a></li></ul></li><li><a href="Controller.AdminController.ResponseController.html">ResponseController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.ResponseController.html#addResponse">addResponse</a></li><li data-type='method'><a href="Controller.AdminController.ResponseController.html#editResponse">editResponse</a></li><li data-type='method'><a href="Controller.AdminController.ResponseController.html#getMarksByCourse">getMarksByCourse</a></li><li data-type='method'><a href="Controller.AdminController.ResponseController.html#getMarksByStudent">getMarksByStudent</a></li><li data-type='method'><a href="Controller.AdminController.ResponseController.html#getMarksByTutorialQuiz">getMarksByTutorialQuiz</a></li><li data-type='method'><a href="Controller.AdminController.ResponseController.html#getResponses">getResponses</a></li></ul></li><li><a href="Controller.AdminController.TutorialQuizController.html">TutorialQuizController</a><ul class='methods'><li data-type='method'><a href="Controller.AdminController.TutorialQuizController.html#editTutorialQuiz">editTutorialQuiz</a></li><li data-type='method'><a href="Controller.AdminController.TutorialQuizController.html#editTutorialsQuizzes">editTutorialsQuizzes</a></li><li data-type='method'><a href="Controller.AdminController.TutorialQuizController.html#getTutorialQuiz">getTutorialQuiz</a></li><li data-type='method'><a href="Controller.AdminController.TutorialQuizController.html#getTutorialsQuizzes">getTutorialsQuizzes</a></li></ul></li><li><a href="Controller.Controller.html">Controller</a><ul class='methods'><li data-type='method'><a href="Controller.Controller.html#.getInstance">getInstance</a></li></ul></li><li><a href="Controller.GuestController.DashboardController.html">DashboardController</a><ul class='methods'><li data-type='method'><a href="Controller.GuestController.DashboardController.html#getHome">getHome</a></li></ul></li><li><a href="Controller.GuestController.GuestSocketController.html">GuestSocketController</a></li><li><a href="Controller.GuestController.LoginController.html">LoginController</a></li><li><a href="Controller.GuestController.LogoutController.html">LogoutController</a><ul class='methods'><li data-type='method'><a href="Controller.GuestController.LogoutController.html#logout">logout</a></li></ul></li><li><a href="Controller.StudentController.FileController.html">FileController</a><ul class='methods'><li data-type='method'><a href="Controller.StudentController.FileController.html#getFileLinkById">getFileLinkById</a></li></ul></li><li><a href="Controller.StudentController.QuestionController.html">QuestionController</a><ul class='methods'><li data-type='method'><a href="Controller.StudentController.QuestionController.html#addQuestion">addQuestion</a></li><li data-type='method'><a href="Controller.StudentController.QuestionController.html#downVoteQuestion">downVoteQuestion</a></li><li data-type='method'><a href="Controller.StudentController.QuestionController.html#getQuestionForm">getQuestionForm</a></li><li data-type='method'><a href="Controller.StudentController.QuestionController.html#upVoteQuestion">upVoteQuestion</a></li></ul></li><li><a href="Controller.StudentController.StudentController.html">StudentController</a><ul class='methods'><li data-type='method'><a href="Controller.StudentController.StudentController.html#getCourses">getCourses</a></li><li data-type='method'><a href="Controller.StudentController.StudentController.html#getQuizzes">getQuizzes</a></li></ul></li><li><a href="EventEmitter.EventEmitter.html">EventEmitter</a><ul class='methods'><li data-type='method'><a href="EventEmitter.EventEmitter.html#emit">emit</a></li></ul></li><li><a href="EventEmitter.SocketIOEventEmitter.SocketIOEventEmitter.html">SocketIOEventEmitter</a><ul class='methods'><li data-type='method'><a href="EventEmitter.SocketIOEventEmitter.SocketIOEventEmitter.html#emit">emit</a></li></ul></li><li><a href="EventEmitter.SocketIOEventEmitter.UserEventEmitter.html">UserEventEmitter</a><ul class='methods'><li data-type='method'><a href="EventEmitter.SocketIOEventEmitter.UserEventEmitter.html#emit">emit</a></li></ul></li><li><a href="IAServiceProvider.html">IAServiceProvider</a><ul class='methods'><li data-type='method'><a href="IAServiceProvider.html#.getAllCourses">getAllCourses</a></li><li data-type='method'><a href="IAServiceProvider.html#.getAllTutorials">getAllTutorials</a></li><li data-type='method'><a href="IAServiceProvider.html#.getLoginUrl">getLoginUrl</a></li><li data-type='method'><a href="IAServiceProvider.html#.getLogoutUrl">getLogoutUrl</a></li><li data-type='method'><a href="IAServiceProvider.html#.getTutorialByIdOrFail">getTutorialByIdOrFail</a></li><li data-type='method'><a href="IAServiceProvider.html#.getUserById">getUserById</a></li><li data-type='method'><a href="IAServiceProvider.html#.getUserByToken">getUserByToken</a></li><li data-type='method'><a href="IAServiceProvider.html#.runGetRequest">runGetRequest</a></li></ul></li><li><a href="Middleware.EnsureAdminMiddleware.html">EnsureAdminMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.EnsureAdminMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.EnsureAuthenticatedMiddleware.html">EnsureAuthenticatedMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.EnsureAuthenticatedMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.Middleware.html">Middleware</a><ul class='methods'><li data-type='method'><a href="Middleware.Middleware.html#.applyToRouter">applyToRouter</a></li><li data-type='method'><a href="Middleware.Middleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.GetCourseByParameterMiddleware.html">GetCourseByParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.GetCourseByParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.GetFileByParameterMiddleware.html">GetFileByParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.GetFileByParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.GetGroupByParameterMiddleware.html">GetGroupByParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.GetGroupByParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.GetQuestionByParameterMiddleware.html">GetQuestionByParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.GetQuestionByParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.GetQuizByParameterMiddleware.html">GetQuizByParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.GetQuizByParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.GetTutorialByParameterMiddleware.html">GetTutorialByParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.GetTutorialByParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.GetTutorialQuizByParameterMiddleware.html">GetTutorialQuizByParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.GetTutorialQuizByParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="Middleware.ParameterMiddleware.ParameterMiddleware.html">ParameterMiddleware</a><ul class='methods'><li data-type='method'><a href="Middleware.ParameterMiddleware.ParameterMiddleware.html#.applyToRouter">applyToRouter</a></li><li data-type='method'><a href="Middleware.ParameterMiddleware.ParameterMiddleware.html#handler">handler</a></li></ul></li><li><a href="RemoteUser.html">RemoteUser</a><ul class='methods'><li data-type='method'><a href="RemoteUser.html#.createList">createList</a></li><li data-type='method'><a href="RemoteUser.html#canAccessAdminPanel">canAccessAdminPanel</a></li><li data-type='method'><a href="RemoteUser.html#getCourse">getCourse</a></li><li data-type='method'><a href="RemoteUser.html#getCourses">getCourses</a></li><li data-type='method'><a href="RemoteUser.html#getId">getId</a></li><li data-type='method'><a href="RemoteUser.html#getUsername">getUsername</a></li><li data-type='method'><a href="RemoteUser.html#isAdmin">isAdmin</a></li><li data-type='method'><a href="RemoteUser.html#isInstructor">isInstructor</a></li><li data-type='method'><a href="RemoteUser.html#isTA">isTA</a></li><li data-type='method'><a href="RemoteUser.html#toJSON">toJSON</a></li></ul></li><li><a href="SocketIO.Connection.html">Connection</a><ul class='methods'><li data-type='method'><a href="SocketIO.Connection.html#.Builder#build">Builder#build</a></li><li data-type='method'><a href="SocketIO.Connection.html#.Builder#setUser">Builder#setUser</a></li><li data-type='method'><a href="SocketIO.Connection.html#disconnectAndRemoveFromPool">disconnectAndRemoveFromPool</a></li><li data-type='method'><a href="SocketIO.Connection.html#getRooms">getRooms</a></li><li data-type='method'><a href="SocketIO.Connection.html#getSocket">getSocket</a></li><li data-type='method'><a href="SocketIO.Connection.html#getUser">getUser</a></li><li data-type='method'><a href="SocketIO.Connection.html#join">join</a></li><li data-type='method'><a href="SocketIO.Connection.html#onEvent">onEvent</a></li></ul></li><li><a href="SocketIO.Connection.Builder.html">Builder</a></li><li><a href="SocketIO.ConnectionPool.html">ConnectionPool</a><ul class='methods'><li data-type='method'><a href="SocketIO.ConnectionPool.html#.getInstance">getInstance</a></li><li data-type='method'><a href="SocketIO.ConnectionPool.html#addConnection">addConnection</a></li><li data-type='method'><a href="SocketIO.ConnectionPool.html#emitToRoom">emitToRoom</a></li><li data-type='method'><a href="SocketIO.ConnectionPool.html#getAllConnections">getAllConnections</a></li><li data-type='method'><a href="SocketIO.ConnectionPool.html#getConnectionsInRoom">getConnectionsInRoom</a></li><li data-type='method'><a href="SocketIO.ConnectionPool.html#removeConnection">removeConnection</a></li><li data-type='method'><a href="SocketIO.ConnectionPool.html#setSocketIOInstance">setSocketIOInstance</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Controller.html">Controller</a></li><li><a href="Controller.AdminController.html">AdminController</a></li><li><a href="Controller.GuestController.html">GuestController</a></li><li><a href="Controller.StudentController.html">StudentController</a></li><li><a href="EventEmitter.html">EventEmitter</a></li><li><a href="EventEmitter.SocketIOEventEmitter.html">SocketIOEventEmitter</a></li><li><a href="Middleware.html">Middleware</a></li><li><a href="Middleware.ParameterMiddleware.html">ParameterMiddleware</a></li><li><a href="SocketIO.html">SocketIO</a></li></ul><h3>Global</h3><ul><li><a href="global.html#invoke">invoke</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Controllers/Admin/ResponseController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*------------------------------------
Controller for admin quiz response management.

Author(s): Jun Zheng [me at jackzh dot com]
-------------------------------------*/

const Controller   = require('../Controller');
const _            = require('lodash');
const async        = require('async');
const csv          = require('csv');
const models       = require('../../Models');
const asyncForEach = require('../../Utils/asyncForEach');

/**
 * Controller for admin quiz response management.
 * @extends Controller
 * @memberOf Controller.AdminController
 */
class ResponseController extends Controller {
    /**
     * Get group response.
     * @param {Object} req Express request.
     * @param {Object} res Express response.
     * @param {function} next Next callback.
     * @returns {Promise&lt;void>}
     */
    async getResponses(req, res, next) {
        // get members, questions, and responses
        async.series([
            done => {
                req.tutorialQuiz.populate({
                    path: 'quiz',
                    model: 'Quiz',
                    select: 'questions',
                    populate: {
                        path: 'questions',
                        model: 'Question',
                        select: 'number type question code choices answers',
                        match: {
                            $or: [
                                {submitter: {$exists: false}},
                                {submitter: {$exists: true}, approved: true}
                            ]
                        }
                    }
                }, done)
            },
            done => {
                let ids = req.tutorialQuiz.quiz ? _.map(req.tutorialQuiz.quiz.questions, '_id') : [];
                req.group.populate([{
                    path: 'members',
                    model: 'User',
                    select: 'name',
                    options: {
                        sort: 'name.first name.last'
                    }
                }, {
                    path: 'responses',
                    model: 'Response',
                    match: {
                        question: {$in: ids}
                    }
                }], done)
            }
        ], err => {
            if (err)
                return next(err);
            let questions = req.tutorialQuiz.quiz.questions,
                responses = req.group.responses;
            // organize results
            questions     = _.map(questions, question => {
                // find response for question
                let response = _.find(responses, response => response.question.equals(question._id));
                // if none, create a dummy one
                if (!response)
                    response = new models.Response();

                question.response = response;
                question.score    = response.points || 0;
                // compare expected answer w/ given answer
                switch (question.type) {
                    case 'multiple choice':
                    case 'multiple select':
                        question.results = _.map(question.choices, choice => {
                            let expected = question.isAnswer(choice),
                                given    = response.isAnswer(choice);
                            return {
                                choice: choice,
                                expected: expected,
                                given: given,
                                correct: (expected &amp;&amp; given || (expected !== given ? false : null))
                            };
                        });
                        break;
                    case 'short answer':
                        let given        = response.answer[0];
                        question.results = {
                            expected: question.answers,
                            given: given,
                            correct: question.isAnswer(given)
                        };
                        break;
                    case 'code tracing':
                        question.results = _.map(question.answers, (answer, i) => {
                            let codeTracingAnswer = response.lineByLineSummary &amp;&amp; response.lineByLineSummary[i] ? response.lineByLineSummary[i].value : null,
                                lineByLineSummary = response.lineByLineSummary ? response.lineByLineSummary[i] : null,
                                attempts          = lineByLineSummary ? lineByLineSummary.attempts : 0,
                                correct           = lineByLineSummary ? lineByLineSummary.correct : false;

                            return {
                                expected: answer,
                                given: codeTracingAnswer,
                                attempts: attempts,
                                correct: answer == codeTracingAnswer
                            };
                        });
                        break;
                    default:
                        break;
                }
                return question;
            });

            res.render('Admin/Pages/GroupResponses', {
                mathjax: true,
                bodyClass: 'responses-page',
                title: 'Responses',
                course: req.course,
                tutorialQuiz: req.tutorialQuiz,
                group: req.group,
                questions: questions
            });
        });
    };

    /**
     * Add a new response.
     * @param {Object} req Express request.
     * @param {Object} res Express response.
     * @param {function} next Next callback.
     * @returns {Promise&lt;void>}
     */
    async addResponse(req, res, next) {
        let response = new models.Response(req.body);
        models.Question.findById(req.body.question, 'number type answers', (err, question) => {
            if (err)
                return next(err);
            // check answers
            if (question.isMultipleChoice() || question.isMultipleSelect()) {
                // correct if all answers were selected
                response.correct = _.isEqual(question.answers.sort(), response.answer.sort());
            } else if (question.isShortAnswer()) {
                // normalize answers
                if (!question.caseSensitive) {
                    question.answers = _.map(question.answers, answer => _.toLower(answer));
                    response.answer  = _.map(response.answer, answer => _.toLower(answer));
                }
                // correct if one of the answers was selected
                response.correct = _.intersection(question.answers, response.answer).length > 0;
            } else if (question.isCodeTracing()) {
                // correct if all answers were selected
                response.correct = _.isEqual(question.answers, _.map(response.lineByLineSummary, line => line.value.trim()));
            }
            response.group = req.group._id;
            response.save(err => {
                if (err)
                    return next(err);
                req.flash('success', 'Response for question &lt;b>%s&lt;/b> has been updated.', question.number);
                res.redirect('back');
            });
        });
    }

    /**
     * Edit a response.
     * @param {Object} req Express request.
     * @param {Object} res Express response.
     * @param {function} next Next callback.
     * @returns {Promise&lt;void>}
     */
    async editResponse(req, res, next) {
        async.series([
            done => models.Question.findById(req.body.question, 'number type answers caseSensitive', done),
            done => models.Response.findById(req.params.response, done)
        ], (err, results) => {
            if (err)
                return next(err);
            let [question, response] = results;

            response.group  = req.group._id;
            response.answer = [];
            response.set(req.body);
            // check answers
            if (question.isMultipleChoice() || question.isMultipleSelect()) {
                // correct if all answers were selected
                response.correct = _.isEqual(question.answers.sort(), response.answer.sort());
            } else if (question.isShortAnswer()) {
                // normalize answers
                if (!question.caseSensitive) {
                    question.answers = _.map(question.answers, answer => _.toLower(answer));
                    response.answer  = _.map(response.answer, answer => _.toLower(answer));
                }
                // correct if one of the answers was selected
                response.correct = _.intersection(question.answers, response.answer).length > 0;
            } else if (question.isCodeTracing()) {
                // correct if all answers were selected
                response.correct = _.isEqual(question.answers, _.map(response.lineByLineSummary, line => line.value.trim()));
            }

            response.save(err => {
                if (err)
                    return next(err);
                req.flash('success', 'Response for question &lt;b>%s&lt;/b> has been updated.', question.number);
                res.redirect('back');
            });
        });
    }

    /**
     * Get student's mark.
     * @param {Object} req Express request.
     * @param {Object} res Express response.
     * @param {function} next Next callback.
     * @returns {Promise&lt;void>}
     */
    async getMarksByStudent(req, res, next) {
        models.TutorialQuiz.aggregate([{
            $match: {tutorial: {$in: req.course.tutorials}}
        }, {
            $lookup: {from: 'tutorials', localField: 'tutorial', foreignField: '_id', as: 'tutorial'}
        }, {
            $unwind: '$tutorial'
        }, {
            $lookup: {from: 'quizzes', localField: 'quiz', foreignField: '_id', as: 'quiz'}
        }, {
            $unwind: '$quiz'
        }, {
            $unwind: '$groups'
        }, {
            $lookup: {from: 'groups', localField: 'groups', foreignField: '_id', as: 'group'}
        }, {
            $unwind: '$group'
        }, {
            $match: {'group.members': {$in: [req.student._id]}}
        }, {
            $lookup: {from: 'responses', localField: 'group._id', foreignField: 'group', as: 'response'}
        }, {
            $unwind: {path: '$response', preserveNullAndEmptyArrays: true}
        }, {
            $group: {
                _id: '$_id',
                tutorial: {$first: '$tutorial'},
                quiz: {$first: '$quiz'},
                group: {$first: '$group'},
                totalPoints: {$sum: '$response.points'}
            }
        }], (err, tutorialQuizzes) => {
            if (err)
                return next(err);
            res.render('Admin/Pages/StudentMarks', {
                title: 'Marks',
                course: req.course,
                student: req.student,
                tutorialQuizzes: tutorialQuizzes,
                totalPoints: _.sumBy(tutorialQuizzes, tutorialQuiz => tutorialQuiz.totalPoints)
            });
        });
    }

    /**
     * Get all marks within a quiz instance.
     * @param {Object} req Express request.
     * @param {Object} res Express response.
     * @param {function} next Next callback.
     * @returns {Promise&lt;void>}
     */
    async getMarksByTutorialQuiz(req, res, next) {

        await req.tutorialQuiz.populate('quiz groups').execPopulate();
        await asyncForEach(req.tutorialQuiz.groups, async group => {
            await group.populate('responses').execPopulate();
            await group.fillMembersFromRemote();
        });

        let data = [];

        req.tutorialQuiz.groups.forEach(group => {
            let groupScore = 0;
            group.responses.forEach(response => {
                groupScore += response.points;
            });
            group.members.forEach(member => {
                let memberData = {};
                memberData.score = groupScore; // Individual score is the group score.
                memberData.member = member;
                memberData.group = group;
                data.push(memberData);
            });
        });

        res.render('Admin/Pages/TutorialQuizMarks', {
            title: 'Marks',
            course: req.course,
            tutorialQuiz: req.tutorialQuiz,
            data
        });


        // models.TutorialQuiz.aggregate([{
        //     $match: {_id: req.tutorialQuiz._id} // DONE
        // }, {
        //     $lookup: {from: 'tutorials', localField: 'tutorial', foreignField: '_id', as: 'tutorial'} // FILLED
        // }, {
        //     $unwind: '$tutorial' // FILLED
        // }, {
        //     $lookup: {from: 'quizzes', localField: 'quiz', foreignField: '_id', as: 'quiz'} // FILLED
        // }, {
        //     $unwind: '$quiz' // FILLED
        // }, {
        //     $unwind: '$groups' // FILLED
        // }, {
        //     $lookup: {from: 'groups', localField: 'groups', foreignField: '_id', as: 'group'} // FILLED
        // }, {
        //     $unwind: '$group' // FILLED
        // }, {
        //     $unwind: '$group.members' // FILLED
        // }, {
        //     $lookup: {from: 'users', localField: 'group.members', foreignField: '_id', as: 'member'} // FILLED
        // }, {
        //     $unwind: '$member' // FILLED
        // }, {
        //     $lookup: {from: 'responses', localField: 'group._id', foreignField: 'group', as: 'response'} // FILLED
        // }, {
        //     $unwind: {path: '$response', preserveNullAndEmptyArrays: true} // FILLED
        // }, {
        //     $group: {
        //         _id: '$member._id',
        //         tutorial: {$first: '$tutorial'},
        //         quiz: {$first: '$quiz'},
        //         member: {$first: '$member'},
        //         group: {$first: '$group'},
        //         totalPoints: {$sum: '$response.points'}
        //     }
        // }, {
        //     $sort: {_id: 1}
        // }], (err, data) => {
        //     if (err)
        //         return next(err);
        //     // export marks into CSV
        //     if (req.query.export === 'true') {
        //         data = _.map(data, d => [
        //             d.member.UTORid,
        //             d.member.studentNumber,
        //             `${d.member.name.first} ${d.member.name.last}`,
        //             d.tutorial.number,
        //             d.quiz.name,
        //             d.group.name,
        //             d.totalPoints
        //         ]);
        //         // set headings
        //         data.unshift(['UTORid', 'Student No.', 'Name', 'Tutorial', 'Quiz', 'Group', 'Mark']);
        //         // send CSV
        //         res.setHeader('Content-disposition', 'attachment; filename=marks.csv');
        //         res.set('Content-Type', 'text/csv');
        //         return csv.stringify(data, (err, output) => {
        //             if (err)
        //                 return next(err);
        //             return res.send(output);
        //         });
        //     }
        //
        //     res.render('Admin/Pages/TutorialQuizMarks', {
        //         title: 'Marks',
        //         course: req.course,
        //         tutorialQuiz: req.tutorialQuiz,
        //         data: data
        //     });
        // });
    }

    /**
     * Get all marks within a course.
     * @param {Object} req Express request.
     * @param {Object} res Express response.
     * @param {function} next Next callback.
     * @returns {Promise&lt;void>}
     */
    async getMarksByCourse(req, res, next) {
        models.TutorialQuiz.aggregate([{
            $match: {_id: {$in: req.body.tutorialQuizzes || []}}
        }, {
            $lookup: {from: 'tutorials', localField: 'tutorial', foreignField: '_id', as: 'tutorial'}
        }, {
            $unwind: '$tutorial'
        }, {
            $lookup: {from: 'quizzes', localField: 'quiz', foreignField: '_id', as: 'quiz'}
        }, {
            $unwind: '$quiz'
        }, {
            $unwind: '$groups'
        }, {
            $lookup: {from: 'groups', localField: 'groups', foreignField: '_id', as: 'group'}
        }, {
            $unwind: '$group'
        }, {
            $unwind: '$group.members'
        }, {
            $lookup: {from: 'users', localField: 'group.members', foreignField: '_id', as: 'member'}
        }, {
            $unwind: '$member'
        }, {
            $lookup: {from: 'responses', localField: 'group._id', foreignField: 'group', as: 'response'}
        }, {
            $unwind: {path: '$response', preserveNullAndEmptyArrays: true}
        }, {
            $group: {
                _id: {tutorialQuiz: '_id', member: '$member._id'},
                tutorial: {$first: '$tutorial'},
                quiz: {$first: '$quiz'},
                group: {$first: '$group'},
                member: {$first: '$member'},
                totalPoints: {$sum: '$response.points'}
            }
        }, {
            $sort: {'member.UTORid': 1, 'tutorialQuiz.quiz.name': 1}
        }], (err, data) => {
            if (err)
                return next(err);
            // export marks into CSV
            if (req.query.export === 'true') {
                data = _.map(data, d => [
                    d.member.UTORid,
                    d.member.studentNumber,
                    `${d.member.name.first} ${d.member.name.last}`,
                    d.tutorial.number,
                    d.quiz.name,
                    d.group.name,
                    d.totalPoints
                ]);
                // set headings
                data.unshift(['UTORid', 'Student No.', 'Name', 'Tutorial', 'Quiz', 'Group', 'Mark']);
                // send CSV
                res.setHeader('Content-disposition', 'attachment; filename=marks.csv');
                res.set('Content-Type', 'text/csv');
                return csv.stringify(data, (err, output) => {
                    if (err)
                        return next(err);
                    return res.send(output);
                });
            }
            res.redirect('back');
        });
    }
}


module.exports = ResponseController;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Dec 10 2018 12:54:06 GMT-0500 (EST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
