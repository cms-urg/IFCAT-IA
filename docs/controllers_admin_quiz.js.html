<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controllers/admin/quiz.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Controller.html">Controller</a></li><li><a href="DashboardController.html">DashboardController</a><ul class='methods'><li data-type='method'><a href="DashboardController.html#.getInstance">getInstance</a></li><li data-type='method'><a href="DashboardController.html#getHome">getHome</a></li></ul></li><li><a href="IAServiceProvider.html">IAServiceProvider</a><ul class='methods'><li data-type='method'><a href="IAServiceProvider.html#.getAllCourses">getAllCourses</a></li><li data-type='method'><a href="IAServiceProvider.html#.getAllTutorials">getAllTutorials</a></li><li data-type='method'><a href="IAServiceProvider.html#.getLoginUrl">getLoginUrl</a></li><li data-type='method'><a href="IAServiceProvider.html#.getLogoutUrl">getLogoutUrl</a></li><li data-type='method'><a href="IAServiceProvider.html#.getTutorialByIdOrFail">getTutorialByIdOrFail</a></li><li data-type='method'><a href="IAServiceProvider.html#.getUserByToken">getUserByToken</a></li><li data-type='method'><a href="IAServiceProvider.html#.runGetRequest">runGetRequest</a></li></ul></li><li><a href="LoginController.html">LoginController</a><ul class='methods'><li data-type='method'><a href="LoginController.html#.getInstance">getInstance</a></li></ul></li><li><a href="LogoutController.html">LogoutController</a><ul class='methods'><li data-type='method'><a href="LogoutController.html#.getInstance">getInstance</a></li><li data-type='method'><a href="LogoutController.html#logout">logout</a></li></ul></li><li><a href="RemoteUser.html">RemoteUser</a><ul class='methods'><li data-type='method'><a href="RemoteUser.html#.createList">createList</a></li><li data-type='method'><a href="RemoteUser.html#canAccessAdminPanel">canAccessAdminPanel</a></li><li data-type='method'><a href="RemoteUser.html#getCourse">getCourse</a></li><li data-type='method'><a href="RemoteUser.html#getCourses">getCourses</a></li><li data-type='method'><a href="RemoteUser.html#getId">getId</a></li><li data-type='method'><a href="RemoteUser.html#getUsername">getUsername</a></li><li data-type='method'><a href="RemoteUser.html#isAdmin">isAdmin</a></li><li data-type='method'><a href="RemoteUser.html#isInstructor">isInstructor</a></li><li data-type='method'><a href="RemoteUser.html#isTA">isTA</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#addQuestion">addQuestion</a></li><li><a href="global.html#addQuiz">addQuiz</a></li><li><a href="global.html#copyQuiz">copyQuiz</a></li><li><a href="global.html#deleteQuestion">deleteQuestion</a></li><li><a href="global.html#deleteQuiz">deleteQuiz</a></li><li><a href="global.html#editQuiz">editQuiz</a></li><li><a href="global.html#editTutorialQuiz">editTutorialQuiz</a></li><li><a href="global.html#fetchQuizJson">fetchQuizJson</a></li><li><a href="global.html#generateGroups">generateGroups</a></li><li><a href="global.html#getQuestion">getQuestion</a></li><li><a href="global.html#getQuestions">getQuestions</a></li><li><a href="global.html#getQuiz">getQuiz</a></li><li><a href="global.html#getQuizzes">getQuizzes</a></li><li><a href="global.html#getTutorialByParam">getTutorialByParam</a></li><li><a href="global.html#getTutorialQuiz">getTutorialQuiz</a></li><li><a href="global.html#getTutorialQuizByParam">getTutorialQuizByParam</a></li><li><a href="global.html#saveGroups">saveGroups</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Controllers/admin/quiz.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const _         = require('lodash');
const async     = require('async');
const mongoose  = require('mongoose');
const models    = require('../../models');
const getAbsUrl = require('../../utils/getAbsUrl');


// Retrieve course
exports.getQuizByParam = (req, res, next, id) => {
    models.Quiz.findById(id, (err, quiz) => {
        if (err)
            return next(err);
        if (!quiz)
            return next(new Error('No quiz is found.'));
        req.quiz = quiz;
        next();
    });
};

/**
 * List of quizzes page
 * @param req
 * @param res
 * @param next
 */
exports.getQuizzes = (req, res, next) => {
    req.course.fillQuizzes().then(() => {
        res.render('admin/pages/course-quizzes', {
            bodyClass: 'quizzes-page',
            title: 'Quizzes',
            course: req.course
        });
    }, next);
};

/**
 * Get one quiz
 * @param req
 * @param res
 * @param next
 */
exports.getQuiz = (req, res, next) => {
    let quiz = req.quiz || new models.Quiz();
    req.course.fillTutorials().then(() => {
        quiz.populate('tutorialQuizzes').execPopulate().then(() => {
            res.render('admin/pages/course-quiz', {
                bodyClass: 'quiz-page',
                title: quiz.isNew ? 'Add New Quiz' : 'Edit Quiz',
                course: req.course,
                quiz: quiz
            });
        }, next);
    }, next);
};

/**
 * Add a new quiz to the store
 * @param req
 * @param res
 * @param next
 */
exports.addQuiz = async (req, res, next) => {
    try {
        let quiz = new models.Quiz();
        await quiz.store(req.body).save();
        await quiz.linkTutorials(req.body.tutorials);
        req.flash('success', '&lt;b>%s&lt;/b> has been created.', quiz.name);
        res.redirect(getAbsUrl(`/admin/courses/${req.course.getId()}/quizzes`));
    } catch (e) {
        next(e);
    }
};

/**
 * Update a quiz
 * @param req
 * @param res
 * @param next
 */
exports.editQuiz = async (req, res, next) => {
    try {
        await req.quiz.store(req.body).save();
        await req.quiz.linkTutorials(req.body.tutorials);
        req.flash('success', '&lt;b>%s&lt;/b> has been updated.', req.quiz.name);
        res.redirect(getAbsUrl(`/admin/courses/${req.course.getId()}/quizzes/${req.quiz._id}/edit`));
    } catch(e) {
        next(e);
    }
};

/**
 * Duplicate a quiz
 * @param req
 * @param res
 * @param next
 */
exports.copyQuiz = (req, res, next) => {
    async.waterfall([
        function (done) {
            req.quiz.withQuestions().execPopulate().then(() => {
                async.mapSeries(req.quiz.questions, (question, done) => {
                    question._id = mongoose.Types.ObjectId();
                    question.isNew = true;
                    question.save(err => {
                        if (err)
                            return done(err);
                        done(null, question._id);
                    });
                }, done);
            }, done);
        },
        function (questions, done) {
            req.quiz._id = mongoose.Types.ObjectId();
            req.quiz.isNew = true;
            req.quiz.name += ' (copy)';
            req.quiz.questions = questions;
            req.quiz.save(done);
        }
    ], err => {
        if (err)
            return next(err);
        req.flash('success', '&lt;b>%s&lt;/b> has been added.', req.quiz.name);
        res.redirect('back');
    });
};

/**
 * Delete a quiz
 * @param req
 * @param res
 * @param next
 */
exports.deleteQuiz = (req, res, next) => {
    req.quiz.remove(err => {
        if (err)
            return next(err);
        req.flash('success', '&lt;b>%s&lt;/b> has been deleted.', req.quiz.name);
        res.redirect('back');
    });
};

/**
 * Get quiz JSON export
 * @param req
 * @param res
 */
exports.fetchQuizJson = (req, res) => {
    models.Quiz
        .findById(req.params.quizId)
        .populate({path: 'questions', select: '-answers'})
        .then((quiz) => res.json(quiz))
        .catch(err => console.err(err));
};</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Nov 27 2018 15:10:58 GMT-0500 (EST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
