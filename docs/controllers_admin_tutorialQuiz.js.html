<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controllers/admin/tutorialQuiz.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Controller.html">Controller</a></li><li><a href="DashboardController.html">DashboardController</a><ul class='methods'><li data-type='method'><a href="DashboardController.html#.getInstance">getInstance</a></li><li data-type='method'><a href="DashboardController.html#getHome">getHome</a></li></ul></li><li><a href="IAServiceProvider.html">IAServiceProvider</a><ul class='methods'><li data-type='method'><a href="IAServiceProvider.html#.getAllCourses">getAllCourses</a></li><li data-type='method'><a href="IAServiceProvider.html#.getAllTutorials">getAllTutorials</a></li><li data-type='method'><a href="IAServiceProvider.html#.getLoginUrl">getLoginUrl</a></li><li data-type='method'><a href="IAServiceProvider.html#.getLogoutUrl">getLogoutUrl</a></li><li data-type='method'><a href="IAServiceProvider.html#.getTutorialByIdOrFail">getTutorialByIdOrFail</a></li><li data-type='method'><a href="IAServiceProvider.html#.getUserByToken">getUserByToken</a></li><li data-type='method'><a href="IAServiceProvider.html#.runGetRequest">runGetRequest</a></li></ul></li><li><a href="LoginController.html">LoginController</a><ul class='methods'><li data-type='method'><a href="LoginController.html#.getInstance">getInstance</a></li></ul></li><li><a href="LogoutController.html">LogoutController</a><ul class='methods'><li data-type='method'><a href="LogoutController.html#.getInstance">getInstance</a></li><li data-type='method'><a href="LogoutController.html#logout">logout</a></li></ul></li><li><a href="RemoteUser.html">RemoteUser</a><ul class='methods'><li data-type='method'><a href="RemoteUser.html#.createList">createList</a></li><li data-type='method'><a href="RemoteUser.html#canAccessAdminPanel">canAccessAdminPanel</a></li><li data-type='method'><a href="RemoteUser.html#getCourse">getCourse</a></li><li data-type='method'><a href="RemoteUser.html#getCourses">getCourses</a></li><li data-type='method'><a href="RemoteUser.html#getId">getId</a></li><li data-type='method'><a href="RemoteUser.html#getUsername">getUsername</a></li><li data-type='method'><a href="RemoteUser.html#isAdmin">isAdmin</a></li><li data-type='method'><a href="RemoteUser.html#isInstructor">isInstructor</a></li><li data-type='method'><a href="RemoteUser.html#isTA">isTA</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#addQuestion">addQuestion</a></li><li><a href="global.html#addQuiz">addQuiz</a></li><li><a href="global.html#copyQuiz">copyQuiz</a></li><li><a href="global.html#deleteQuestion">deleteQuestion</a></li><li><a href="global.html#deleteQuiz">deleteQuiz</a></li><li><a href="global.html#editQuiz">editQuiz</a></li><li><a href="global.html#editTutorialQuiz">editTutorialQuiz</a></li><li><a href="global.html#fetchQuizJson">fetchQuizJson</a></li><li><a href="global.html#generateGroups">generateGroups</a></li><li><a href="global.html#getQuestion">getQuestion</a></li><li><a href="global.html#getQuestions">getQuestions</a></li><li><a href="global.html#getQuiz">getQuiz</a></li><li><a href="global.html#getQuizzes">getQuizzes</a></li><li><a href="global.html#getTutorialByParam">getTutorialByParam</a></li><li><a href="global.html#getTutorialQuiz">getTutorialQuiz</a></li><li><a href="global.html#getTutorialQuizByParam">getTutorialQuizByParam</a></li><li><a href="global.html#saveGroups">saveGroups</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Controllers/admin/tutorialQuiz.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*------------------------------------
Controller for admin pages that conducts quizzes.

Author(s): Jun Zheng [me at jackzh dot com]
-------------------------------------*/

const _         = require('lodash');
const async     = require('async');
const getAbsUrl = require('../../utils/getAbsUrl');

const TutorialQuiz = require('../../models/TutorialQuiz');
const models       = require('../../models');

/**
 * Middleware that retrieves one tutorial quiz by parameters
 * This will also fill the 'tutorial' path from remote.
 * @param req
 * @param res
 * @param next
 * @param id
 */
exports.getTutorialQuizByParam = async (req, res, next, id) => {
    let tutorialQuiz = await TutorialQuiz.findById(id);
    if (!tutorialQuiz) {
        throw new Error("No tutorial quiz is found.");
    }
    await tutorialQuiz.fillTutorialFromRemote();
    req.tutorialQuiz = tutorialQuiz;
    next();
};

// Retrieve quizzes within course OR by tutorial
exports.getTutorialsQuizzes = (req, res, next) => {
    let page    = parseInt(req.query.page, 10) || 1,
        perPage = parseInt(req.query.perPage, 10) || 10;

    let query = {quiz: {$in: req.course.quizzes}};
    if (req.tutorial)
        query = {tutorial: req.tutorial};

    let tutorialQuizzes;
    models.TutorialQuiz.find({})
        .populate('quiz')
        .then(result => {
            tutorialQuizzes = result;
            let chain       = [];
            tutorialQuizzes.forEach(tutorialQuiz => {
                chain.push(tutorialQuiz.fillTutorialFromRemote());
            });
            return Promise.all(chain);
        })
        .then(() => {
            res.render('admin/pages/tutorials-quizzes', {
                bodyClass: 'tutorials-quizzes-page',
                title: 'Conduct Quizzes',
                course: req.course,
                // tutorial: req.tutorial,
                tutorialQuizzes
            });
        })
        .catch(e => {
            next(e);
        })

    // models.TutorialQuiz.findAndCount(query, {
    //     page: page,
    //     perPage: perPage
    // }, (err, tutorialsQuizzes, count, pages) => {
    //     if (err)
    //         return next(err);
    //     res.render('admin/pages/tutorials-quizzes', {
    //         bodyClass: 'tutorials-quizzes-page',
    //         title: 'Conduct Quizzes',
    //         course: req.course,
    //         tutorial: req.tutorial,
    //         tutorialsQuizzes: tutorialsQuizzes,
    //         pagination: {
    //             page: page,
    //             pages: pages,
    //             perPage: perPage
    //         }
    //     });
    // });
};

// Edit quizzes 
exports.editTutorialsQuizzes = (req, res, next) => {
    let items  = req.body.tutorialsQuizzes || [];
    let update = _.reduce(req.body.update, (obj, field) => {
        obj[field] = /^(published|active|archived)$/.test(field) ? !!req.body[field] : req.body[field];
        return obj;
    }, {});
    // update each tutorial-quiz
    async.eachSeries(items, (id, done) => {
        models.TutorialQuiz.findByIdAndUpdate(id, update, {new: true}, (err, tutorialQuiz) => {
            if (err)
                return done(err);
            // send notification
            req.app.locals.io.in('tutorialQuiz:' + tutorialQuiz._id).emit('quizActivated', tutorialQuiz);
            done();
        });
    }, err => {
        if (err)
            return next(err);
        req.flash('success', 'List of quizzes have been updated.');
        res.redirect('back');
    });
};

/**
 * Retrieve one quiz for the tutorial
 * @param req
 * @param res
 * @param next
 */
exports.getTutorialQuiz = async (req, res, next) => {
    try {
        await req.tutorialQuiz.populate([
            {path: 'quiz'},
            {path: 'groups'}
        ]).execPopulate();
        await req.tutorialQuiz.tutorial.fillStudentsFromRemote();
        res.render('admin/pages/tutorial-quiz', {
            bodyClass: 'tutorial-quiz-page',
            title: `Conduct ${req.tutorialQuiz.quiz.name} in ${req.tutorialQuiz.tutorial.getDisplayName()}`,
            course: req.course,
            tutorialQuiz: req.tutorialQuiz,
            tutorial: req.tutorialQuiz.tutorial,
            quiz: req.tutorialQuiz.quiz,
            students: req.tutorialQuiz.tutorial.getStudents(),
            groups: _.sortBy(req.tutorialQuiz.groups, group => _.toInteger(group.name))
        });
    } catch (e) {
        next(e);
    }
};


/**
 * Edit tutorial quiz settings
 * @param req
 * @param res
 * @param next
 */
exports.editTutorialQuiz = async (req, res, next) => {

    try {
        await req.tutorialQuiz.fillTutorialFromRemote();
        await req.tutorialQuiz.populate('quiz').execPopulate();

        // update tutorial-quiz
        await req.tutorialQuiz.set({
            allocateMembers: req.body.allocateMembers,
            maxMembersPerGroup: req.body.maxMembersPerGroup,
            published: !!req.body.published,
            active: !!req.body.active,
            archived: !!req.body.archived
        }).save();

        // TODO: This part makes no sense, double check later with student UI
        req.app.locals.io.in('tutorialQuiz:' + req.tutorialQuiz._id).emit('quizActivated', req.tutorialQuiz);
        req.flash('success', '&lt;b>%s&lt;/b> settings have been updated for &lt;b>TUT %s&lt;/b>.', req.tutorialQuiz.quiz.name, req.tutorialQuiz.tutorial.getDisplayName());
        res.redirect(getAbsUrl(`/admin/courses/${req.course.getId()}/tutorials-quizzes/${req.tutorialQuiz._id}`));
    } catch (e) {
        next(e);
    }

};</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Nov 27 2018 15:10:58 GMT-0500 (EST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
