<%- include ./header -%>
<div class="row">
    <div class = "col-xs-10 col-xs-offset-1 alert alert-info">
        A <b>published</b> quiz is available for students in the tutorial to open and be assigned to a group automatically (you can assign/change groups manually at any time).
        An <b>active</b> quiz is one currently in progress: the questions are visible to students and they can submit responses while a quiz is active.
        Note that students will not be automatically assigned to groups while a quiz is active - you will have to do it manually.
    </div>
    <br/>
</div>
<div class="row">
    <label class="col-xs-3 col-sm-2 col-md-2 col-lg-1 control-label">Published?</label>
    <div class="col-xs-3 col-sm-2 col-md-2 col-lg-1">
        <input type="checkbox" id="publish-tutorial-quiz" value="1" class="bootstrap-switch"<%= 
            tutorialQuiz.published ? ' checked' : '' %>>
    </div>
    <label class="col-xs-3 col-sm-2 col-md-2 col-lg-1 control-label">Active?</label>
    <div class="col-xs-3 col-sm-2 col-md-2 col-lg-1">
        <input type="checkbox" id="activate-tutorial-quiz" value="1" class="bootstrap-switch"<%= 
            tutorialQuiz.active ? ' checked' : '' %>>
    </div>
</div>

<h1>Groups</h1>

<%- include ./messages %>

<form action="/admin/courses/<%= course.id %>/tutorial-quizzes/<%= tutorialQuiz.id %>/groups?_method=put" 
    method="post" id="form-quiz-groups">
    <button type="button" class="btn btn-default btn-sm" id="btn-refresh-groups"><span 
    class="glyphicon glyphicon-refresh"></span> Refresh</button>
    <button type="button" class="btn btn-default btn-sm" id="btn-add-group"><span 
    class="glyphicon glyphicon-plus"></span> Add group</button>
    <button type="submit" class="btn btn-default btn-sm btn-primary pull-right">Save</button>
    
    <table>
        <thead>
            <tr>
                <th rowspan="2" class="s">&nbsp;</th>
                <th colspan="<%= 1 + tutorialQuiz.groups.length %>">Groups</th>
            </tr>
            <tr>
                <th class="u">Unassigned</th>
            <% _.each(tutorialQuiz.groups, function (group) { %>
                <th class="g"><%= group.name %></th>
            <% }) %>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th rowspan="2" class="s">&nbsp;</th>
                <th class="u">Unassigned</th>
                <% _.each(tutorialQuiz.groups, function (group) { %>
                    <th class="g"><%= group.name %></th>
                <% }) %>
            </tr>
            <tr>
                <th colspan="<%= 1 + tutorialQuiz.groups.length %>">Groups</th>
            </tr>
        </tfoot>
        <tbody>
        <% _.each(tutorialQuiz.tutorial.students, function (student) { %>
            <tr>
                <td class="s">
                    <a href="/admin/courses/<%= course.id %>/students/<%= student.id %>/marks"><%= student.name.full %></a>
                </td>
                <td class="u">
                    <input type="radio" name="groups[<%= student.id %>]" value="unassigned"<%=
                        !_.find(tutorialQuiz.groups, function (group) { 
                            return _.find(group.members, { id: student.id });
                        }) ? ' checked' : '' %>>
                </td>
                <% _.each(tutorialQuiz.groups, function (group) { %>
                    <td class="g"><input type="radio" name="groups[<%= student.id %>]" value="<%= group.id %>"<%=
                        _.find(group.members, { id: student.id }) ? ' checked' : '' %>></td>
                <% }) %>
            </tr>
        <% }) %>
        </tbody>
    </table>
</form>

<script type="text/template" id="panel-group-template">
    <div class="panel panel-default" data-group-id="new">
        <div class="panel-heading" data-parent="#panel-groups" data-target="#group-${ id }">
            <h4 class="panel-title">New group</h4>
            <a href="#" class="btn btn-defaut"><span class="glyphicon glyphicon-remove"></span> Delete Group</a>
        </div>
        <div id="group-${ id }" class="panel-collapse collapse in">
            <div class="panel-body sortable"></div>
        </div>
    </div>
</script>

<!--input type="hidden" id="save-groups-url" 
    value="/admin/courses/<%= course.id %>/tutorial-quizzes/<%= tutorialQuiz.id %>/groups/save"-->

<input type="hidden" id="publish-tutorial-quiz-url" 
    value="/admin/courses/<%= course.id %>/tutorial-quizzes/<%= tutorialQuiz.id %>/publish">
<input type="hidden" id="activate-tutorial-quiz-url" 
    value="/admin/courses/<%= course.id %>/tutorial-quizzes/<%= tutorialQuiz.id %>/activate">


<%- include ./body-js -%>

<script>
$(function () {
    // publish/unpublish quiz in tutorial
    $('#publish-tutorial-quiz').on('switchChange.bootstrapSwitch', function (e, state) {
        $.ajax($('#publish-tutorial-quiz-url').val(), {
            type: 'put',
            data: { published: state }, 
            success: function (res) {
                console.log(res.status);
            }
        });
    });
    // activate/deactivate quiz in tutorial
    $('#activate-tutorial-quiz').on('switchChange.bootstrapSwitch', function (e, state) {
        $.ajax($('#activate-tutorial-quiz-url').val(), {
            type: 'put',
            data: { active: state }, 
            success: function (res) {
                console.log(res.status);
            }
        });
    });
    // add new group to table
    $('#btn-add-group').click(function () {
        var $table = $(this).closest('form').find('table'),
            $thead = $table.find('thead'),
            $tfoot = $table.find('tfoot'),
            $tbody = $table.find('tbody');
        // get next group #
        var numbers = [];
        $thead.find('tr:eq(1) th').each(function () {
            if (!isNaN(this.innerText)) {
                numbers.push(parseInt(this.innerText, 10));
            }
        });
        var value = _.toInteger(_.max(numbers)) + 1;
        // increment colspan
        $thead.find('tr:eq(0) th:eq(1)').attr('colspan', function (i, attr) { 
            return parseInt(attr, 10) + 1; 
        });
        $tfoot.find('tr:eq(1) th:eq(0)').attr('colspan', function (i, attr) { 
            return parseInt(attr, 10) + 1; 
        });
        // add header column
        $thead.find('tr:eq(1)').append('<th class="g">' + value + '</th>');
        $tfoot.find('tr:eq(0)').append('<th class="g">' + value + '</th>');
        // add body column
        $tbody.find('tr').each(function () { 
            var $tr = $(this);
            var name = $tr.find(':radio:eq(0)').attr('name');
            $tr.append('<th class="g"><input type="radio" name="' + name + '" value="' + value + '"></th>');
        });
    });
    // save changes
    $('#form-quiz-groups').submit(function (e) {
        e.preventDefault();
        var $form = $(this);
        // send request
        $.ajax(this.action, {
            type: 'put',
            data: $form.serialize(), 
            success: function (res) {
                if (res.status) {
                    window.location.reload(true);
                }
            }
        });
    });
    // refresh table
    $('#btn-refresh-groups').click(function (e) {
        e.preventDefault();
        window.location.reload(true);
    });
});
</script>

<%- include ./footer -%>