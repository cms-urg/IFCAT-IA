<%- include ./header -%>

<ol class="breadcrumb">
    <li><a href="/admin/courses">Courses</a> ‐ <%= course.code %></li>
    <li><a href="/admin/courses/<%= course.id %>/tutorials">Tutorials</a> ‐ TUT <%= tutorial.number %></li>
    <li><a href="/admin/courses/<%= course.id %>/tutorials/<%= tutorial.id %>/quizzes">Quizzes</a> ‐ <%= quiz.name %></li>
    <li class="active">Conduct</li>
</ol>

<h2 id="title"><%- title %></h2>

<%- include ./flash %>

<ul class="nav nav-tabs">
    <li class="active"><a href="#settings" data-toggle="tab">Settings</a></li>
    <li><a href="#groups" data-toggle="tab">Groups</a></li>
</ul>
<div class="tab-content">
    <div class="tab-pane active" id="settings">
        <br>  
        <form action="/admin/courses/<%= course.id %>/tutorials/<%= tutorial.id %>/quizzes/<%= quiz.id %>?_method=put" 
            method="post" class="form-horizontal" style="max-width: 700px">
            <div class="form-group">
                <label class="col-xs-4 col-sm-4 control-label">Allocate members by</label>
                <div class="col-xs-7 col-sm-8">
                    <select name="allocateMembers" class="form-control">
                        <option value="automatically"<%= tutorialQuiz.allocateMembers === 'automatically' ? 
                            ' selected' : '' %>>automatically assigning users to groups as they sign in</option>
                        <option value="self-selection"<%= tutorialQuiz.allocateMembers === 'self-selection' ? 
                            ' selected' : '' %>>allowing users to assign themselves to groups as they sign in</option> 
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-4 col-sm-4 control-label">Set group size</label>
                <div class="col-xs-4 col-sm-3">
                    <input type="number" name="max[membersPerGroup]" value="<%= tutorialQuiz.max.membersPerGroup %>" 
                        min="1" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-4 col-sm-4 control-label">Publish quiz?</label>
                <div class="col-xs-4 col-sm-8">
                    <input type="checkbox" value="1" class="bootstrap-switch" name="published"<%= 
                        tutorialQuiz.published ? ' checked' : '' %>>
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-4 col-sm-4 control-label">Activate quiz?</label>
                <div class="col-xs-4 col-sm-8">
                    <input type="checkbox" value="1" class="bootstrap-switch" name="active"<%= 
                        tutorialQuiz.active ? ' checked' : '' %>>
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-4 col-sm-4 control-label">Archive quiz?</label>
                <div class="col-xs-4 col-sm-8">
                    <input type="checkbox" value="1" class="bootstrap-switch" name="archived"<%= 
                        tutorialQuiz.archived ? ' checked' : '' %>>
                </div>
            </div>
            <div class="form-group">
                <div class="col-xs-offset-4 col-sm-offset-4 col-xs-8 col-sm-8">
                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                </div>
            </div>
        </form>
    </div>
    <div class="tab-pane" id="groups">
        <form action="/admin/courses/<%= course.id %>/tutorials/<%= tutorial.id %>/quizzes/<%= quiz.id %>/groups?_method=put" 
            method="post">
            <div class="nav-actions">
                <a href="/admin/courses/<%= course.id %>/tutorials/<%= tutorial.id %>/quizzes/<%= quiz.id %>/conduct" 
                    class="btn btn-default btn-sm btn-primary"><span class="glyphicon glyphicon-triangle-left"></span> Revert</a>
                <a href="/admin/courses/<%= course.id %>/tutorials/<%= tutorial.id %>/quizzes/<%= quiz.id %>/groups/generate" 
                    class="btn btn-default btn-sm"><span class="glyphicon glyphicon-random"></span> Randomize Groups</a>
                <button type="button" class="btn btn-default btn-sm" id="btn-add"><span 
                    class="glyphicon glyphicon-plus"></span> Add New Group</button>
                <button type="button" class="btn btn-default btn-sm" id="btn-remove"><span 
                    class="glyphicon glyphicon-remove"></span> Remove Selected Groups</button>
                <button type="submit" class="btn btn-default btn-sm btn-primary" id="btn-save"><span 
                    class="glyphicon glyphicon-ok"></span> Save Groups</button>
            </div>
            <p class="help-block"><span class="glyphicon glyphicon-info-sign"></span> All changes must be saved.</p>
            <table class="stretch">
                <thead>
                    <tr>
                        <th rowspan="2" class="s">&nbsp;</th>
                        <th colspan="<%= 1 + groups.length %>" id="thgroup">Groups</th>
                    </tr>
                    <tr>
                        <th class="u">Unassigned</th>
                        <% _.each(groups, function (group) { %>
                            <th class="g" data-group="<%= group.id %>"><%= group.name %></th>
                        <% }) %>
                    </tr>
                </thead>
                <tbody>
                <% if (_.isEmpty(students)) { %>
                    <tr>
                        <td colspan="2">No students have been added into the tutorial yet.</td>
                    </tr>
                <% } else { %>
                    <% _.each(students, function (student) { %>
                        <tr>
                            <td class="s"><%= student.name.full %></td>
                            <td class="u"><input type="radio" name="groups[<%= student.id %>]" value="unassigned"></td>
                            <% _.each(groups, function (group) { %>
                                <td class="g" data-group="<%= group.id %>"><input type="radio" name="groups[<%= student.id %>]" 
                                    value="<%= group.id %>"<%= group.members.indexOf(student.id) > -1 ? ' checked' : '' %>></td>
                            <% }) %>
                        </tr>
                    <% }) %>
                <% } %>
                </tbody>
            </table>
        </form>
    </div>
</div>

<%- include ./body-js -%>

<script>
$(function () {
    var $tab = $('#groups'), 
        $table = $tab.find('table'),
        $thead = $table.find('thead'),
        $tbody = $table.find('tbody'),
        $thgroup = $table.find('#thgroup');
    // add new group to table
    $('#btn-add').click(function () {
        // get next group #
        var number = _.toInteger($thead.find('tr:eq(1) th:last-child').text()) + 1;
        // add header column
        $thead.find('tr:eq(1)').append('<th class="g" data-group="' + number + '">' + number + '</th>');
        // add body column
        $tbody.find('tr').append(function () {
            var name = $(this).find('td.u > :radio')[0].name;
            return '<td class="g" data-group="' + number + '"><input type="radio" name="' + name + '" value="' + number + '"></td>';
        });

        $thgroup.attr('colspan', $table.find('tbody tr:eq(0) td:gt(0)').length);
    });
    // check unassigned
    $table.find('tr').each(function () {
        $(':radio:eq(0)', this).prop('checked', !$(':checked', this).length);
    });
    // select/unselect column
    $table.on('click', 'th.g', function () {
        $table.find('[data-group=' + this.dataset.group + ']').toggleClass('selected');
    });
    // remove selected
    $('#btn-remove').click(function () {
        $table.find('.selected').each(function () {
            if (this.tagName === 'TH' && this.dataset.group && isNaN(this.dataset.group)) {
                $table.after('<input type="hidden" name="trash[]" value="' + this.dataset.group + '">');
            }
            $(this).remove();
        });
        $thgroup.attr('colspan', $table.find('tbody tr:eq(0) td:gt(0)').length);
    });
});
</script>

<%- include ./footer -%>
